<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="converterPageTitle">Converter ‚Äî Music Jacker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body class="text-white min-h-screen flex flex-col items-center p-4 selection:bg-sky-500 selection:text-white bg-mode-night">
    <div class="night-sky-bg-main">
        <div class="moon-main"></div>
        <div class="reactbits-bg-layer reactbits-dot-grid" data-bg-layer="dot-grid">
            <div class="dot-grid-pattern"></div>
            <div class="dot-grid-glow"></div>
        </div>
        <div class="reactbits-bg-layer reactbits-faulty-terminal" data-bg-layer="faulty-terminal">
            <div class="faulty-terminal-noise"></div>
            <div class="faulty-terminal-scanline"></div>
            <div class="faulty-terminal-glitch"></div>
        </div>
        <div class="reactbits-bg-layer reactbits-aurora" data-bg-layer="aurora">
            <div class="aurora-band aurora-band-one"></div>
            <div class="aurora-band aurora-band-two"></div>
            <div class="aurora-stars"></div>
        </div>
        <div class="reactbits-bg-layer reactbits-dither" data-bg-layer="dither">
            <div class="dither-overlay"></div>
        </div>
    </div>

    <header class="top-nav-container">
        <button id="navToggleButton" class="nav-toggle-button" aria-label="Collapse navigation" aria-expanded="true">
            <span class="icon-up">‚ñ≤</span>
            <span class="icon-down">‚ñº</span>
        </button>
        <div class="fluid-glass-nav">
            <div class="fluid-blob one"></div>
            <div class="fluid-blob two"></div>
            <div class="fluid-blob three"></div>
                <div class="fluid-nav-content">
                    <div class="top-nav-buttons">
                        <button id="infoButton" class="nav-button" data-translate-key="navInfoButton">Info</button>
                        <button id="copyrightButton" class="nav-button" data-translate-key="navCopyrightButton">Copyright</button>
                        <button id="shareButton" class="nav-button" data-translate-key="navShareButton">Share</button>
                        <button id="updatesButton" class="nav-button" data-translate-key="navUpdatesButton">Updates (Blog)</button>
                        <button id="githubButton" class="nav-button" data-translate-key="navGithubButton">GitHub</button>
                        <button id="converterButton" class="nav-button" data-translate-key="navConverterButton">Converter</button>
                    </div>
                <div class="header-controls">
                    <div class="lang-switcher-container">
                        <label for="languageSelector" data-translate-key="languageLabel">Language:</label>
                        <select id="languageSelector" title="Select Language">
                            <option value="en">English</option>
                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                            <option value="es">Espa√±ol</option>
                            <option value="az">Az…ôrbaycanca</option>
                            <option value="tr">T√ºrk√ße</option>
                        </select>
                    </div>
                    <div class="background-switcher-container">
                        <label for="backgroundSelector" data-translate-key="backgroundLabel">Background:</label>
                        <select id="backgroundSelector" title="Select Background">
                            <option value="night" data-translate-key="backgroundNight">Night Sky</option>
                            <option value="faulty-terminal" data-translate-key="backgroundFaultyTerminal">Faulty Terminal</option>
                            <option value="dot-grid" data-translate-key="backgroundDotGrid">Dot Grid</option>
                            <option value="aurora" data-translate-key="backgroundAurora">Aurora</option>
                            <option value="dither" data-translate-key="backgroundDither">Dither</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="app-container w-full max-w-4xl mt-16">
        <section class="main-card p-8">
            <h1 class="text-3xl font-bold mb-4" data-translate-key="converterH1">File Converter</h1>
            <p class="text-sm text-slate-400 mb-4" data-translate-key="converterSupportedFormats">Supported conversions: mp3 ‚Üí m4a, webp ‚Üí jpg, mp4 ‚Üí mp3</p>

            <form id="converterForm" class="space-y-4">
                <style>
                    .file-chooser {
                        display: inline-flex; align-items: center; gap: .75rem;
                        width: 100%; padding: .75rem 1rem; border-radius: .75rem;
                        background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
                        border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(6px) saturate(120%);
                        box-shadow: 0 6px 20px rgba(2,6,23,0.5), inset 0 1px 0 rgba(255,255,255,0.02);
                        cursor: pointer; transition: transform .18s ease, box-shadow .18s ease, background-position 1.5s linear;
                        background-size: 300% 300%;
                    }
                    .file-chooser:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.03); }
                    .file-chooser .chooser-label { font-weight: 700; color: #e6f6ff; padding-right: .5rem; }
                    .file-chooser .chooser-sub { font-size: .85rem; color: #9aa9b8; }
                    .file-chooser .liquid-blob {
                        width: 44px; height: 36px; border-radius: .5rem;
                        background: linear-gradient(135deg, rgba(14,165,233,0.2), rgba(99,102,241,0.22));
                        box-shadow: 0 6px 18px rgba(14,165,233,0.12), inset 0 -8px 30px rgba(255,255,255,0.02);
                        transition: transform .25s ease; display:flex; align-items:center; justify-content:center; color:#061426;
                    }
                    .file-chooser[data-state='ready'] { background-position: 50% 50%; }
                    .file-chooser .filename { font-size: .95rem; color: #e2eef7; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }

                    @keyframes liquidPulse {
                        0% { transform: translateY(0) scale(1); opacity: .95 }
                        50% { transform: translateY(-4px) scale(1.02); opacity: 1 }
                        100% { transform: translateY(0) scale(1); opacity: .95 }
                    }
                    .file-chooser.pulsing .liquid-blob { animation: liquidPulse 1.6s ease-in-out infinite; }

                    @media (max-width: 640px) {
                        .main-card { padding: 1.25rem; }
                        .file-chooser { gap: .5rem; padding: .6rem .8rem; }
                        .file-chooser .chooser-label { font-size: 0.95rem; }
                    }
                </style>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2" data-translate-key="converterUploadLabel">Choose file (max 5 minutes for audio/video):</label>
                    <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4">
                        <input id="converter_file" name="file" type="file" accept="audio/*,video/*,image/*" class="sr-only" aria-hidden="true">
                        <label id="converterChooser" for="converter_file" role="button" tabindex="0" class="file-chooser" data-state="empty" aria-label="Select file">
                            <div class="liquid-blob" aria-hidden="true">üìÅ</div>
                            <div class="flex-1 min-w-0 text-left">
                                <div class="chooser-label" data-translate-key="converterChooseFile">Choose file</div>
                                <div class="chooser-sub hidden sm:block" id="converterChooserSub">Max 5 minutes</div>
                            </div>
                            <div class="filename hidden sm:block text-slate-400 text-right" id="converterFilename">&nbsp;</div>
                        </label>
                        <div id="converterFilenameMobile" class="mt-2 sm:hidden text-xs text-slate-400 truncate"></div>
                    </div>
                </div>

                <div>
                    <label for="target_format" class="block text-sm font-medium text-slate-300 mb-2" data-translate-key="converterTargetLabel">Convert to:</label>
                    <select id="target_format" name="target_format" class="w-full px-4 py-3 bg-slate-700/70 border-2 border-slate-600 rounded-lg text-white focus:ring-0 focus:border-sky-500 transition duration-200 ease-in-out">
                        <option value="m4a" data-translate-key="converterFmt_m4a">M4A (from MP3)</option>
                        <option value="mp3" data-translate-key="converterFmt_mp3">MP3 (from MP4)</option>
                        <option value="wav" data-translate-key="converterFmt_wav">WAV (from MP3)</option>
                        <option value="flac" data-translate-key="converterFmt_flac">FLAC (from MP3)</option>
                        <option value="jpg" data-translate-key="converterFmt_jpg">JPG (from WEBP)</option>
                        <option value="png" data-translate-key="converterFmt_png">PNG (from WEBP/JPG)</option>
                        <option value="gif" data-translate-key="converterFmt_gif">GIF (from WEBP)</option>
                    </select>
                </div>

                <div>
                    <button id="convertSubmit" type="submit" class="submit-button w-full bg-sky-500 hover:bg-sky-400 text-slate-900 font-semibold py-3.5 px-4 rounded-lg shadow-lg" data-translate-key="converterSubmitButton">Convert</button>
                </div>

                <div id="fileInfo" class="mt-3 text-sm text-slate-300 hidden">
                    <div><strong data-translate-key="converterFileName">File name:</strong> <span id="infoName">&nbsp;</span></div>
                    <div><strong data-translate-key="converterFileSize">Size:</strong> <span id="infoSize">&nbsp;</span></div>
                    <div><strong data-translate-key="converterFileType">Type:</strong> <span id="infoType">&nbsp;</span></div>
                </div>

                <div class="mt-4">
                    <div id="progressWrap" class="w-full bg-slate-700/40 rounded-full h-3 overflow-hidden" style="display:none;">
                        <div id="progressBar" class="h-3 bg-sky-400 w-0 transition-all duration-300"></div>
                    </div>
                    <div id="progressText" class="mt-2 text-xs text-slate-400"></div>
                </div>

                <div id="converterStatus" class="mt-4 min-h-[56px] text-sm text-slate-300"></div>
            </form>
        </section>
    </main>

    <footer class="w-full text-center text-slate-400 mt-auto py-6">&copy; <span id="year"></span> thebitsamurai</footer>

    <section id="infoSectionOverlay" class="overlay-section">
        <button id="closeInfoButton" class="close-overlay-button" aria-label="Close Info">√ó</button>
        <div class="info-content-card">
            <h2 data-translate-key="infoTitle">Information</h2>
            <h3 data-translate-key="infoHowItWorksTitle">How This Site Works</h3>
            <p data-translate-key="infoHowItWorksPara1">This web application allows you to download audio/video from YouTube, SoundCloud or other videos/tracks or playlists. You simply paste the URL, choose your desired format (MP3, M4A, Opus or MP4), and the server-side script processes your request.</p>
            <p data-translate-key="infoHowItWorksPara2">The backend uses the powerful <code>yt-dlp</code> library to fetch content information and extract the audio/video stream. If MP3, M4A, Opus or MP4 format is selected, <code>ffmpeg</code> is used for conversion and to embed metadata.</p>
            <p data-translate-key="infoHowItWorksPara3">The downloaded file is temporarily stored on the server and then made available for you to download directly through your browser. After the download is served to you, the file is automatically deleted from the server to save space and ensure privacy.</p>

            <h3 data-translate-key="infoLibrariesTitle">Key Libraries & Technologies Used</h3>
            <ul>
                <li data-translate-key="infoLibFlask"><strong>Flask:</strong> A micro web framework for Python, used to build the backend API.</li>
                <li data-translate-key="infoLibYtdlp"><strong>yt-dlp:</strong> A command-line program to download videos/audio from YouTube, SoundCloud and many other sites. It's a fork of youtube-dl with additional features and fixes.</li>
                <li data-translate-key="infoLibFFmpeg"><strong>FFmpeg:</strong> A complete, cross-platform solution to record, convert and stream audio and video. Used here for format conversion (to MP3/M4A/Opus/MP4) and metadata embedding.</li>
                <li data-translate-key="infoLibTailwind"><strong>Tailwind CSS:</strong> A utility-first CSS framework for rapidly building custom user interfaces.</li>
                <li data-translate-key="infoLibJS"><strong>JavaScript:</strong> Used for frontend interactivity, language switching, animations, and communication with the backend API.</li>
            </ul>

            <h3 data-translate-key="infoPythonCodeTitle">Python Backend Code</h3>
            <p data-translate-key="infoPythonCodePara">The core backend logic is written in Python using the Flask framework. The Python script (typically named <code>app.py</code>) handles API requests, interacts with <code>yt-dlp</code> and <code>ffmpeg</code>, manages temporary file storage, and serves the files. This code runs on the server and is not directly visible here, but it ensures the functionality of the downloader.</p>

            <h3 data-translate-key="infoCreatorTitle">Creator</h3>
            <p data-translate-key="infoCreatorName">This Music Jacker site was created by <strong>thebitsamurai</strong>.</p>
        </div>
    </section>

    <section id="copyrightSectionOverlay" class="overlay-section">
        <button id="closeCopyrightButton" class="close-overlay-button" aria-label="Close Copyright">√ó</button>
        <div class="info-content-card">
            <h2 data-translate-key="copyrightTitle">Copyright & Responsibility</h2>
            <p data-translate-key="copyrightPara1">Please be aware that music and other audio content available on YouTube, SoundCloud and other platforms may be protected by copyright. Many artists and content creators have specific licenses and terms of use for their work. It is your responsibility to ensure that you have the necessary rights or permissions before downloading any content.</p>
            <p data-translate-key="copyrightPara2">The developer of this site provides this tool for convenience and is not responsible for the content you choose to download or how you use it. By using this service, you agree that you are solely responsible for your actions and for complying with all applicable copyright laws and terms of service of the content providers.</p>
        </div>
    </section>

    <section id="shareSectionOverlay" class="overlay-section">
        <button id="closeShareButton" class="close-overlay-button" aria-label="Close Share">√ó</button>
        <div class="info-content-card share-card">
            <h2 data-translate-key="shareTitle">Share Music Jacker</h2>
            <p class="share-desc" data-translate-key="shareDescription">Scan the QR code or use the button below to open Music Jacker on another device.</p>
            <div class="qr-display">
                <img src="{{ url_for('static', filename='musicjackerqrcode.png') }}" alt="Music Jacker QR code" class="qr-image">
            </div>
            <button id="nativeShareButton" class="share-primary-button" data-translate-key="shareCta">Share</button>
            <p class="share-hint" data-translate-key="shareNativeHint">If native sharing is unavailable, we will copy the link for you.</p>
        </div>
    </section>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const converterForm = document.getElementById('converterForm');
            const fileInput = document.getElementById('converter_file');
            const targetSelect = document.getElementById('target_format');
            const statusEl = document.getElementById('converterStatus');

            const updatesButton = document.getElementById('updatesButton');
            const githubButton = document.getElementById('githubButton');
            const converterButton = document.getElementById('converterButton');

            if (updatesButton) updatesButton.addEventListener('click', () => { window.location.href = '/miniblog'; });
            if (githubButton) githubButton.addEventListener('click', () => { window.open('https://github.com/thebitsamuraii23/MusicJacker-Site', '_blank'); });
            if (converterButton) converterButton.addEventListener('click', () => { window.location.href = '/converter'; });

            async function pollStatus(jobId) {
                while (true) {
                    try {
                        const res = await fetch(`/api/convert/status/${jobId}`);
                        const json = await res.json();
                        if (json.status === 'processing' || json.status === 'queued') {
                            const pct = Math.round((json.progress || 0));
                            statusEl.innerHTML = `<div>${getTranslation('converterProgressLabel')} ‚Äî ${pct}%</div>`;
                            const progressWrap = document.getElementById('progressWrap');
                            const progressBar = document.getElementById('progressBar');
                            const progressText = document.getElementById('progressText');
                            if (progressWrap) progressWrap.style.display = 'block';
                            if (progressBar) progressBar.style.width = `${pct}%`;
                            if (progressText) progressText.textContent = `${getTranslation('converterProgressPercent', undefined, {PERCENT: pct})}`;
                            try { converterChooser.classList.add('pulsing'); } catch(e){}
                        } else if (json.status === 'done') {
                            try { converterChooser.classList.remove('pulsing'); } catch(e){}
                            statusEl.innerHTML = `<div>${getTranslation('converterResultReady')}: <a class='text-sky-400 hover:underline' href='${json.download_url}'>${getTranslation('statusDownloadLinkText', undefined, {FORMAT: out_ext ? out_ext.toUpperCase() : 'FILE'})}</a></div>`;
                            const progressBar = document.getElementById('progressBar');
                            if (progressBar) progressBar.style.width = `100%`;
                            break;
                        } else if (json.status === 'error') {
                            try { converterChooser.classList.remove('pulsing'); } catch(e){}
                                    const code = (json && json.error_code) ? json.error_code : null;
                                    let msg = json.message || 'Conversion error';
                                    if (code) {
                                        if (code === 'too_long') msg = getTranslation('converterErrorTooLong');
                                        else if (code === 'unsupported_conversion') msg = getTranslation('converterErrorUnsupported');
                                        else if (code === 'ffmpeg_missing') msg = getTranslation('converterErrorFFmpegMissing');
                                        else if (code === 'conversion_failed') msg = getTranslation('converterErrorConversionFailed');
                                    }
                                    statusEl.innerHTML = `<div class='text-red-400'>${msg}</div>`;
                            break;
                        }
                    } catch (err) {
                        statusEl.innerHTML = `<div class='text-red-400'>${err.message}</div>`;
                        break;
                    }
                    await new Promise(r => setTimeout(r, 900));
                }
            }

            let out_ext = null;
            converterForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!fileInput.files || fileInput.files.length === 0) {
                    statusEl.innerHTML = `<div class='text-red-400'>${getTranslation('statusErrorUrl') || 'Please choose a file.'}</div>`;
                    return;
                }

                const file = fileInput.files[0];
                const fd = new FormData();
                fd.append('file', file);
                fd.append('target', targetSelect.value);

                    statusEl.innerHTML = `<div>${getTranslation('converterProgressLabel')} ‚Äî 0%</div>`;
                    const progressWrap = document.getElementById('progressWrap'); if (progressWrap) { progressWrap.style.display = 'block'; }

                try {
                        out_ext = targetSelect.value;
                        const resp = await fetch('/api/convert', { method: 'POST', body: fd });
                    const data = await resp.json();
                    if (!resp.ok) {
                        statusEl.innerHTML = `<div class='text-red-400'>${data.message || 'Upload failed'}</div>`;
                        return;
                    }
                    statusEl.innerHTML = `<div>${getTranslation('converterProgressLabel')} ‚Äî 1%</div>`;
                    const progressBar = document.getElementById('progressBar'); if (progressBar) progressBar.style.width = '1%';
                    try { converterChooser.classList.add('pulsing'); } catch(e){}
                    pollStatus(data.job_id);
                } catch (err) {
                    statusEl.innerHTML = `<div class='text-red-400'>${err.message}</div>`;
                }
            });

            const converterChooser = document.getElementById('converterChooser');
            const converterFilename = document.getElementById('converterFilename');
            const converterFilenameMobile = document.getElementById('converterFilenameMobile');
            const converterChooserSub = document.getElementById('converterChooserSub');
            const fileInfoNode = document.getElementById('fileInfo');
            const infoName = document.getElementById('infoName');
            const infoSize = document.getElementById('infoSize');
            const infoType = document.getElementById('infoType');
            const progressWrapNode = document.getElementById('progressWrap');
            const progressBarNode = document.getElementById('progressBar');
            const progressTextNode = document.getElementById('progressText');

            const supportedMap = {
                'mp3': ['m4a','wav','ogg','aac','flac','opus','mp4'],
                'm4a': ['mp3','wav','flac','aac','ogg','opus'],
                'wav': ['mp3','m4a','flac','aac','ogg','opus'],
                'mp4': ['mp3','m4a','wav','aac'],
                'aac': ['mp3','m4a','wav','flac','opus'],
                'ogg': ['mp3','wav','m4a','flac'],
                'flac': ['mp3','wav','m4a'],
                'webp': ['jpg','png','gif','bmp','tiff'],
                'png': ['jpg','webp','gif','tiff'],
                'jpg': ['png','webp','gif','tiff'],
                'svg': ['png','jpg','webp'],
                'tiff': ['png','jpg']
            };

            if (converterChooserSub) converterChooserSub.textContent = getTranslation('converterMaxDurationWarning');

            fileInput.addEventListener('change', () => {
                if (!fileInput.files || fileInput.files.length === 0) {
                    if (converterChooser) converterChooser.dataset.state = 'empty';
                    if (converterFilename) { converterFilename.textContent = ''; converterFilename.classList.add('hidden'); }
                    if (converterFilenameMobile) converterFilenameMobile.textContent = '';
                    if (fileInfoNode) fileInfoNode.classList.add('hidden');
                    if (progressWrapNode) progressWrapNode.style.display = 'none';
                    return;
                }
                const f = fileInput.files[0];
                const name = f.name || 'file';
                if (converterFilename) { converterFilename.textContent = name; converterFilename.classList.remove('hidden'); }
                if (converterFilenameMobile) converterFilenameMobile.textContent = name;
                if (converterChooser) converterChooser.dataset.state = 'ready';

                if (fileInfoNode) fileInfoNode.classList.remove('hidden');
                if (infoName) infoName.textContent = name;
                if (infoSize) infoSize.textContent = `${(f.size/1024).toFixed(1)} KB`;
                if (infoType) infoType.textContent = f.type || 'n/a';

                // validate target availability for this file's extension
                const ext = (name.split('.').pop() || '').toLowerCase();
                const targetSelectEl = document.getElementById('target_format');
                function checkCompatibility() {
                    const target = targetSelectEl.value;
                    const ok = supportedMap[ext] && supportedMap[ext].includes(target);
                    document.getElementById('convertSubmit').disabled = !ok;
                    if (!ok) {
                        statusEl.innerHTML = `<div class='text-yellow-300'>${getTranslation('converterValidationUnsupported')}</div>`;
                    } else {
                        statusEl.innerHTML = '';
                    }
                }
                if (targetSelect) targetSelect.addEventListener('change', checkCompatibility);
                checkCompatibility();

                if (f.type && (f.type.startsWith('audio/') || f.type.startsWith('video/'))) {
                    const media = f.type.startsWith('audio/') ? document.createElement('audio') : document.createElement('video');
                    media.preload = 'metadata';
                    media.src = URL.createObjectURL(f);
                    media.onloadedmetadata = () => {
                        URL.revokeObjectURL(media.src);
                        if (media.duration && media.duration > 300) {
                            statusEl.innerHTML = `<div class='text-red-400'>${getTranslation('converterMaxDurationWarning')}</div>`;
                            fileInput.value = '';
                            if (converterFilename) { converterFilename.textContent = ''; converterFilename.classList.add('hidden'); }
                            if (converterFilenameMobile) converterFilenameMobile.textContent = '';
                            if (converterChooser) converterChooser.dataset.state = 'empty';
                        } else {
                            if (converterChooser) converterChooser.classList.add('pulsing');
                            setTimeout(()=>{ if (converterChooser) converterChooser.classList.remove('pulsing'); }, 1100);
                        }
                    };
                    media.onerror = () => {
                        if (converterChooser) { converterChooser.classList.add('pulsing'); setTimeout(()=>converterChooser.classList.remove('pulsing'),1100); }
                    };
                } else {
                    if (converterChooser) { converterChooser.classList.add('pulsing'); setTimeout(()=>converterChooser.classList.remove('pulsing'),1100); }
                }
            });

            const yearSpan = document.getElementById('year'); if (yearSpan) yearSpan.textContent = new Date().getFullYear();
        });
    </script>
</body>
</html>
